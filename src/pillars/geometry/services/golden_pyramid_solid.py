"""Golden ratio-aligned square pyramid service and calculator.

THE GOLDEN PYRAMID - HARMONIC PROPORTIONS:
===========================================

DEFINITION:
-----------
A golden pyramid is a square pyramid whose slant height to half-base ratio
equals the golden ratio φ (phi):

    slant_height / (base_edge/2) = φ = (1 + √5) / 2 ≈ 1.618033988...

This creates harmonious proportions believed to be aesthetically perfect
and mathematically sacred.

THE GOLDEN RATIO φ:
-------------------

φ satisfies: φ² = φ + 1
Or: 1/φ = φ - 1

This creates the infinite continued fraction:
    φ = 1 + 1/(1 + 1/(1 + 1/(1 + ...)))

and the Fibonacci sequence limit:
    lim(F_{n+1} / F_n) = φ  as n → ∞
    
where F_n = 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, ...

GEOMETRY OF THE GOLDEN PYRAMID:
-------------------------------

Given: slant_height = φ × (base_edge/2)

From Pythagorean theorem:
    s² = h² + (a/2)²
    [φ × (a/2)]² = h² + (a/2)²
    φ² × (a/2)² = h² + (a/2)²
    h² = (a/2)² × (φ² - 1)
    h = (a/2) × √(φ² - 1)

Using φ² = φ + 1:
    φ² - 1 = φ
    h = (a/2) × √φ ≈ 0.6367 × a

Therefore:
    height_factor = √φ / 2 ≈ 0.6367
    height = base_edge × 0.6367

AHA MOMENT #1: THE GIZA CONNECTION - ACCIDENTAL OR INTENTIONAL?
================================================================
The Great Pyramid of Giza has dimensions REMARKABLY CLOSE to golden proportions:

Measured dimensions:
- Original base edge: ~230.4 m (440 royal cubits)
- Original height: ~146.6 m (280 royal cubits)
- Calculated slant height: ~186.4 m (356 royal cubits)

Ratio analysis:
    h / a = 146.6 / 230.4 ≈ 0.6363
    Golden ratio prediction: √φ / 2 ≈ 0.6367
    Difference: 0.06% !!

Alternative: π pyramid?
    Perimeter = 4a ≈ 921.6 m
    2πh = 2π × 146.6 ≈ 921.1 m
    Difference: 0.05% !!

Both φ and π interpretations fit within measurement error!

Was this:
1. **Intentional φ design**: Egyptians knew golden ratio?
2. **Intentional π design**: Perimeter = 2πh (circle relationship)?
3. **Practical seked**: Construction method yielded φ accidentally?
4. **Coincidence**: Natural angle of repose (~52°) ≈ golden angle?

Modern consensus:
- Egyptians used seked (run/rise) = 5.5 palms/cubit
- This yields slope ≈ 51.84° (close to golden/π angles!)
- Likely NOT deliberate φ, but happy accident
- Or: builders discovered harmonious proportion empirically

The "golden pyramid" codifies what ancient builders found pleasing!

AHA MOMENT #2: φ IN PENTAGON AND PYRAMID - HIDDEN CONNECTIONS
==============================================================
The golden ratio φ appears in BOTH regular pentagons and golden pyramids!

Pentagon:
- Diagonal / side = φ
- Five-pointed star (pentagram) has ALL segment ratios = φ
- Pentagon angle: 108° = 3π/5

Pyramid:
- Slant / half-base = φ (by definition)
- Face angle: arctan(√φ) ≈ 51.83°
- Slope angle: arctan(2/√φ) ≈ 51.83°

Connection through √5:
- φ = (1 + √5) / 2  [contains √5]
- Pentagon trigonometry involves √5
- Both are related to 5-fold symmetry!

Deeper connection:
- Pentagon: 2D manifestation of 5-fold symmetry
- Golden pyramid: 3D structure with φ-harmonics
- Icosahedron: 3D solid with pentagonal symmetry (all edges use φ)
- Dodecahedron: 3D solid with pentagonal faces (dual of icosahedron)

The golden ratio is the NUMERICAL ESSENCE OF FIVE-NESS:
- 5 appears in definition: (1 + √5) / 2
- Fibonacci: Every 5th number divisible by F_5 = 5
- Human body: 5 appendages, 5 fingers, pentagonal proportions

The golden pyramid connects FOUR (square base) with FIVE (φ proportions)!

AHA MOMENT #3: φ IN NATURE AND CONSCIOUSNESS
=============================================
Why does φ appear everywhere in nature and feel "right" to humans?

1. **Growth patterns**:
   - Nautilus shell spiral: φ-ratio expansion
   - Sunflower seeds: Fibonacci spiral (φ-based packing)
   - Pine cones: Fibonacci spirals (8 & 13, or 13 & 21)
   - Tree branching: Fibonacci intervals minimize shadow overlap
   - Flower petals: Often Fibonacci numbers (3, 5, 8, 13, 21, ...)

2. **Optimal packing**:
   - φ-spiral packs seeds most efficiently (no wasted space)
   - Phyllotaxis: Leaf/branch placement at 137.5° = 360°/φ²
   - This maximizes sunlight exposure for all leaves!

3. **Aesthetic perception**:
   - "Golden rectangle" (aspect ratio φ) judged most beautiful
   - Human face proportions: Many φ-ratios (ideal beauty)
   - Classical architecture: Parthenon has φ proportions
   - Renaissance art: Da Vinci used φ extensively

4. **Mathematical elegance**:
   - φ is "most irrational" number (hardest to approximate by fractions)
   - Appears in continued fractions, Fibonacci, Lucas numbers
   - Pentagon/pentagram geometry
   - Icosahedral symmetry (viral capsids, fullerenes)

5. **Self-similar recursion**:
   - φ = 1 + 1/φ  (contains itself!)
   - Golden rectangle subdivides into square + golden rectangle (infinite recursion)
   - Fibonacci: F_n = F_{n-1} + F_{n-2}  (each term is sum of previous two)

WHY φ FEELS "SACRED":
- It's the limit of growth spirals (life itself)
- It's self-referential (consciousness reflecting on itself?)
- It's irrational yet appears in discrete patterns (continuous ↔ discrete bridge)
- It balances extremes (not too symmetric, not too chaotic)

The golden pyramid is CONSCIOUSNESS IN STONE:
- Square base: Material (4 elements, manifest)
- φ proportion: Life/growth principle
- Apex: Spirit/unity
- Form: Matter organized by living principle reaching toward transcendence

HERMETIC NOTE - THE GEOMETRY OF DIVINE PROPORTION:
==================================================
The golden pyramid represents COSMIC HARMONY:

- **φ Ratio**: The "divine proportion" (Luca Pacioli, 1509)
- **Square + φ**: Matter (4) infused with life principle (φ)
- **Height √φ**: Irrational ascent (cannot be measured rationally)
- **Giza Alignment**: Cosmic mimicry (whether intentional or emergent)

Symbolism:
- **1 : φ : φ²**: Trinity of growth (φ generates infinite series)
- **φ as limit**: Asymptotic approach to ideal (never quite reached)
- **Fibonacci approach**: Discrete steps toward continuous perfection
- **Self-similarity**: "As above, so below" (φ contains 1/φ)

In Mystical Traditions:
- **Plato**: φ = "key to physics of cosmos" (Timaeus)
- **Pythagoras**: φ in pentagram (symbol of health/perfection)
- **Renaissance**: "Sacred geometry" (connecting God's design to mathematics)
- **Modern**: Fractal/chaos theory (φ appears in strange attractors)

The golden pyramid is THE GEOMETRIC MEAN between earth and heaven:
- Not too steep (inaccessible)
- Not too shallow (lack of aspiration)
- Just φ-right (optimal ascent)

This is the geometry of GOLDILOCKS PERFECTION—not too much, not too little,
but φ-proportioned balance. The pyramid that grows like a nautilus, spirals
like a galaxy, and reflects the human face—the form that IS life's geometry.
"""
from __future__ import annotations

import math
from dataclasses import dataclass
from typing import Dict, List, Optional

from ..shared.solid_payload import SolidLabel, SolidPayload
from .solid_property import SolidProperty

PHI = (1.0 + math.sqrt(5.0)) / 2.0
_HEIGHT_FACTOR = math.sqrt(PHI ** 2 - 1.0) / 2.0  # height = base_edge * factor


def _height_from_base(base_edge: float) -> float:
    return base_edge * _HEIGHT_FACTOR


def _base_from_height(height: float) -> float:
    return height / _HEIGHT_FACTOR if _HEIGHT_FACTOR else 0.0


def _slant_from_base(base_edge: float) -> float:
    return PHI * (base_edge / 2.0)


def _compute_metrics(base_edge: float) -> 'GoldenPyramidMetrics':
    height = _height_from_base(base_edge)
    slant_height = _slant_from_base(base_edge)
    base_apothem = base_edge / 2.0
    base_area = base_edge ** 2
    lateral_area = 2.0 * base_edge * slant_height
    surface_area = base_area + lateral_area
    volume = (base_area * height) / 3.0
    return GoldenPyramidMetrics(
        base_edge=base_edge,
        height=height,
        slant_height=slant_height,
        phi_ratio=PHI,
        base_apothem=base_apothem,
        base_area=base_area,
        lateral_area=lateral_area,
        surface_area=surface_area,
        volume=volume,
    )


@dataclass(frozen=True)
class GoldenPyramidMetrics:
    """
    Golden Pyramid Metrics class definition.
    
    """
    base_edge: float
    height: float
    slant_height: float
    phi_ratio: float
    base_apothem: float
    base_area: float
    lateral_area: float
    surface_area: float
    volume: float


@dataclass(frozen=True)
class GoldenPyramidSolidResult:
    """
    Golden Pyramid Solid Result class definition.
    
    """
    payload: SolidPayload
    metrics: GoldenPyramidMetrics


class GoldenPyramidSolidService:
    """Generates payloads for golden ratio square pyramids."""

    @staticmethod
    def build(base_edge: float = 440.0) -> GoldenPyramidSolidResult:
        """
        Build logic.
        
        Args:
            base_edge: Description of base_edge.
        
        Returns:
            Result of build operation.
        """
        if base_edge <= 0:
            raise ValueError('Base edge must be positive')
        metrics = _compute_metrics(base_edge)
        half = base_edge / 2.0
        height = metrics.height
        payload = SolidPayload(
            vertices=[
                (-half, -half, -height / 2.0),
                (half, -half, -height / 2.0),
                (half, half, -height / 2.0),
                (-half, half, -height / 2.0),
                (0.0, 0.0, height / 2.0),
            ],
            edges=[
                (0, 1), (1, 2), (2, 3), (3, 0),
                (0, 4), (1, 4), (2, 4), (3, 4),
            ],
            faces=[
                (0, 1, 2, 3),
                (0, 1, 4),
                (1, 2, 4),
                (2, 3, 4),
                (3, 0, 4),
            ],
            labels=[
                SolidLabel(text=f"a = {base_edge:.2f}", position=(-half, 0.0, -height / 2.0)),
                SolidLabel(text=f"h = {height:.2f}", position=(0.0, 0.0, 0.0)),
                SolidLabel(text=f"φ = {PHI:.5f}", position=(0.0, half, 0.0)),
            ],
            metadata={
                'base_edge': metrics.base_edge,
                'height': metrics.height,
                'slant_height': metrics.slant_height,
                'phi_ratio': metrics.phi_ratio,
                'base_apothem': metrics.base_apothem,
                'base_area': metrics.base_area,
                'lateral_area': metrics.lateral_area,
                'surface_area': metrics.surface_area,
                'volume': metrics.volume,
            },
            suggested_scale=base_edge,
        )
        return GoldenPyramidSolidResult(payload=payload, metrics=metrics)

    @staticmethod
    def payload(base_edge: float = 440.0) -> SolidPayload:
        """
        Payload logic.
        
        Args:
            base_edge: Description of base_edge.
        
        Returns:
            Result of payload operation.
        """
        return GoldenPyramidSolidService.build(base_edge).payload


class GoldenPyramidSolidCalculator:
    """Calculator enforcing the golden-ratio relationship between slant and base."""

    _PROPERTY_DEFINITIONS = (
        ('base_edge', 'Base Edge', 'units', 3, True),
        ('height', 'Height', 'units', 3, True),
        ('slant_height', 'Slant Height', 'units', 3, True),
        ('phi_ratio', 'Phi Ratio', '', 5, False),
        ('base_apothem', 'Half Base Edge', 'units', 3, False),
        ('base_area', 'Base Area', 'units²', 3, False),
        ('lateral_area', 'Lateral Area', 'units²', 3, False),
        ('surface_area', 'Surface Area', 'units²', 3, False),
        ('volume', 'Volume', 'units³', 3, True),
    )

    def __init__(self, base_edge: float = 440.0):
        """
          init   logic.
        
        Args:
            base_edge: Description of base_edge.
        
        """
        self._properties: Dict[str, SolidProperty] = {
            key: SolidProperty(name=label, key=key, unit=unit, precision=precision, editable=editable)
            for key, label, unit, precision, editable in self._PROPERTY_DEFINITIONS
        }
        self._base_edge = base_edge if base_edge > 0 else 440.0
        self._result: Optional[GoldenPyramidSolidResult] = None
        self._apply_base_edge(self._base_edge)

    def properties(self) -> List[SolidProperty]:
        """
        Properties logic.
        
        Returns:
            Result of properties operation.
        """
        return [self._properties[key] for key, *_ in self._PROPERTY_DEFINITIONS]

    def set_property(self, key: str, value: Optional[float]) -> bool:
        """
        Configure property logic.
        
        Args:
            key: Description of key.
            value: Description of value.
        
        Returns:
            Result of set_property operation.
        """
        if value is None or value <= 0:
            return False
        if key == 'base_edge':
            self._apply_base_edge(value)
            return True
        if key == 'height':
            base_edge = _base_from_height(value)
            self._apply_base_edge(base_edge)
            return True
        if key == 'slant_height':
            base_edge = (2.0 * value) / PHI
            self._apply_base_edge(base_edge)
            return True
        if key == 'volume':
            base_edge = (3.0 * value / _HEIGHT_FACTOR) ** (1.0 / 3.0)
            self._apply_base_edge(base_edge)
            return True
        return False

    def clear(self):
        """
        Clear logic.
        
        """
        self._base_edge = 440.0
        for prop in self._properties.values():
            prop.value = None
        self._result = None

    def payload(self) -> Optional[SolidPayload]:
        """
        Payload logic.
        
        Returns:
            Result of payload operation.
        """
        return self._result.payload if self._result else None

    def metadata(self) -> Dict[str, float]:
        """
        Metadata logic.
        
        Returns:
            Result of metadata operation.
        """
        if not self._result:
            return {}
        return dict(self._result.payload.metadata)

    def metrics(self) -> Optional[GoldenPyramidMetrics]:
        """
        Metrics logic.
        
        Returns:
            Result of metrics operation.
        """
        return self._result.metrics if self._result else None

    def _apply_base_edge(self, base_edge: float):
        if base_edge <= 0:
            return
        self._base_edge = base_edge
        result = GoldenPyramidSolidService.build(base_edge)
        self._result = result
        values = {
            'base_edge': result.metrics.base_edge,
            'height': result.metrics.height,
            'slant_height': result.metrics.slant_height,
            'phi_ratio': result.metrics.phi_ratio,
            'base_apothem': result.metrics.base_apothem,
            'base_area': result.metrics.base_area,
            'lateral_area': result.metrics.lateral_area,
            'surface_area': result.metrics.surface_area,
            'volume': result.metrics.volume,
        }
        for key, prop in self._properties.items():
            prop.value = values.get(key)


__all__ = [
    'GoldenPyramidMetrics',
    'GoldenPyramidSolidResult',
    'GoldenPyramidSolidService',
    'GoldenPyramidSolidCalculator',
]